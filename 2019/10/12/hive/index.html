<!DOCTYPE html>
<html>
<head hexo-theme="https://github.com/volantis-x/hexo-theme-volantis/tree/4.0.0-rc.4"><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="x-dns-prefetch-control" content="on">

  <!-- 页面元数据 -->
  
  <title>hive - 玖玖的博客</title>
  
    <meta name="keywords" content="hive,ing">
  

  
    <meta name="description" content=" 

hive 的读书笔记，ing">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14/css/all.min.css">
  
  

  

  

  

  

  <!-- import link -->
  

  
  
    <link rel="stylesheet" href="/css/style.css">
  
  
  
  <!-- 脚本懒加载函数 -->
  <script>
  function loadScript(src, cb) {
    var HEAD = document.getElementsByTagName('head')[0] || document.documentElement;
    var script = document.createElement('script');
    script.setAttribute('type','text/javascript');
    if (cb) script.onload = cb;
    script.setAttribute('src', src);
    HEAD.appendChild(script);
  }
  //https://github.com/filamentgroup/loadCSS
  !function(c){"use strict";var e=function(e,t,n,r){var o,i=c.document,a=i.createElement("link");if(t)o=t;else{var d=(i.body||i.getElementsByTagName("head")[0]).childNodes;o=d[d.length-1]}var f=i.styleSheets;if(r)for(var l in r)r.hasOwnProperty(l)&&a.setAttribute(l,r[l]);a.rel="stylesheet",a.href=e,a.media="only x",function e(t){if(i.body)return t();setTimeout(function(){e(t)})}(function(){o.parentNode.insertBefore(a,t?o:o.nextSibling)});var s=function(e){for(var t=a.href,n=f.length;n--;)if(f[n].href===t)return e();setTimeout(function(){s(e)})};function u(){a.addEventListener&&a.removeEventListener("load",u),a.media=n||"all"}return a.addEventListener&&a.addEventListener("load",u),(a.onloadcssdefined=s)(u),a};"undefined"!=typeof exports?exports.loadCSS=e:c.loadCSS=e}("undefined"!=typeof global?global:this);
  </script>
  <script id="loadcss"></script>
</head>

<body>
  <header class="l_header auto shadow blur " style='opacity: 0' >
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
            <img no-lazy class='logo' src='https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/blog/Logo-NavBar@3x.png'/>
          
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

  <div class="l_body">
    <div class="l_cover">
  
    
    
        <div class='cover-wrapper post dock' style="display: none;">
          
            <div class='cover-bg lazyload placeholder' data-bg="https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/033.jpg"></div>
          
          <div class='cover-body'>
  <div class='top'>
    
    
      <p class="title">Volantis</p>
    
    
  </div>
  <div class='bottom'>
    <div class='menu navigation'>
      <div class='list-h'>
        
          
            <a href="/v4/getting-started/"
              
              
              id="v4getting-started">
              <img src='https://cdn.jsdelivr.net/gh/twitter/twemoji@13.0/assets/svg/1f5c3.svg'><p>文档</p>
            </a>
          
            <a href="/faqs/"
              
              
              id="faqs">
              <img src='https://cdn.jsdelivr.net/gh/twitter/twemoji@13.0/assets/svg/1f516.svg'><p>帮助</p>
            </a>
          
            <a href="/examples/"
              
              
              id="examples">
              <img src='https://cdn.jsdelivr.net/gh/twitter/twemoji@13.0/assets/svg/1f396.svg'><p>示例</p>
            </a>
          
            <a href="/contributors/"
              
              
              id="contributors">
              <img src='https://cdn.jsdelivr.net/gh/twitter/twemoji@13.0/assets/svg/1f389.svg'><p>社区</p>
            </a>
          
            <a href="/archives/"
              
              
              id="archives">
              <img src='https://cdn.jsdelivr.net/gh/twitter/twemoji@13.0/assets/svg/1f4f0.svg'><p>博客</p>
            </a>
          
            <a href="https://github.com/volantis-x/hexo-theme-volantis/"
              
              
              id="https:githubcomvolantis-xhexo-theme-volantis">
              <img src='https://cdn.jsdelivr.net/gh/twitter/twemoji@13.0/assets/svg/1f9ec.svg'><p>源码</p>
            </a>
          
        
      </div>
    </div>
  </div>
</div>

          <div class="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
        </div>
    
  
  </div>
  
    <div class='safearea'>
      <div class='body-wrapper' id="pjax-container">
        
          <!--此文件用来存放一些不方便取值的变量--> 
<!--思路大概是将值藏到重加载的区域内--> 
 
 
 
<div id="pjax-data" style="display: none"> 
  <div id="pjax-ispage">true</div> 
  <div id="pjax-pageTitle">hive</div> 
  <div id="pjax-enable-cover">true</div> 
  <div id="pjax-comment-path"></div> 
  <div id="pjax-comment-placeholder"></div> 
</div> 
 
 
<script> 
  // 处理封面 此时 jquery 还没加载 
  if ("none" == "none") { // 移除封面 
    document.getElementsByClassName('cover-wrapper')[0].style.display = "none"; 
    document.getElementsByClassName('l_header', 'cover-wrapper')[0].classList.add("show"); 
  } else { 
    if ("none" == "half") { // 半屏 
      document.getElementsByClassName('cover-wrapper')[0].setAttribute('id', 'half'); 
      document.getElementsByClassName('scroll-down')[0].style.display = "none"; 
    } else if ("none" == "full") { // 全屏 
      document.getElementsByClassName('cover-wrapper')[0].setAttribute('id', 'full'); 
      document.getElementsByClassName('scroll-down')[0].style.display = ""; 
    } 
    document.getElementsByClassName('cover-wrapper')[0].style.display = ""; 
    document.getElementsByClassName('l_header', 'cover-wrapper')[0].classList.remove("show"); 
  } 
</script> 
 

        
        

<div class='l_main'>
  <article class="article post white-box reveal md shadow article-type-post" id="post" itemscope itemprop="blogPost">
  


  
  <div class="article-meta" id="top">
    
    
    
      <h1 class="title">
        hive
      </h1>
      <div class='new-meta-box'>
        
          
            
<div class='new-meta-item author'>
  <a class='author' href="/" rel="nofollow">
    <img no-lazy src="">
    <p>请设置文章作者</p>
  </a>
</div>

          
        
          
            
  <div class='new-meta-item category'>
    <a class='notlink'>
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <a class="category-link" href="/categories/hive/">hive</a>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Oct 12, 2019</p>
  </a>
</div>

          
        
          
            
  <div class="new-meta-item browse leancloud">
    <a class='notlink'>
      
      <div id="lc-pv" data-title="hive" data-path="/2019/10/12/hive/">
        <i class="fas fa-eye fa-fw" aria-hidden="true"></i>
        <span id='number'><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
        次浏览
      </div>
    </a>
  </div>


          
        
      </div>
    
  </div>


  
  <excerpt in="" index="" |="" 首页摘要=""> 

<p>hive 的读书笔记，ing</p>
<a id="more"></a>
<the rest="" of="" contents="" |="" 余下全文="">



<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ul>
<li style="list-style: none"><input type="checkbox" checked> 第 3 章</li>
<li style="list-style: none"><input type="checkbox" checked> 第 4 章<ul>
<li style="list-style: none"><input type="checkbox"> 4.4.2 自定义表的存储格式</li>
<li style="list-style: none"><input type="checkbox"> 4.6.7 </li>
</ul>
</li>
<li style="list-style: none"><input type="checkbox" checked> 第 5 章</li>
<li style="list-style: none"><input type="checkbox" checked> 第 6 章<ul>
<li style="list-style: none"><input type="checkbox" checked> 6.9.2 分桶表的输入裁剪</li>
</ul>
</li>
<li style="list-style: none"><input type="checkbox" checked> 第 7 章 视图</li>
<li style="list-style: none"><input type="checkbox"> 第 8 章 粗略看了</li>
<li style="list-style: none"><input type="checkbox" checked> 第 9 章<ul>
<li style="list-style: none"><input type="checkbox"> 9.5</li>
</ul>
</li>
</ul>
<p>头部寻址</p>
<p>Hadoop 每次指定的文件输入和输出路径都是<strong>文件夹</strong></p>
<h3 id="hive-变量空间"><a href="#hive-变量空间" class="headerlink" title="hive 变量空间"></a>hive 变量空间</h3><table>
<thead>
<tr>
<th>命名空间</th>
<th>使用权限</th>
<th>详细描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>hivevar</td>
<td>rw</td>
<td>用户自定义变量（v0.8.0+）</td>
</tr>
<tr>
<td>hiveconf</td>
<td>rw</td>
<td>hive相关配置属性</td>
</tr>
<tr>
<td>system</td>
<td>rw</td>
<td>java定义的配置属性</td>
</tr>
<tr>
<td>env</td>
<td>r</td>
<td>Shell环境属性</td>
</tr>
</tbody>
</table>
<p>通常我们可以使用hive -e查看有关hivevar与hiveconf的描述：</p>
<p><strong>2、hivevar与hiveconf的作用域</strong></p>
<p>之前项目中涉及两个hive作业同时执行并需要传入相同key的参数，因此顾虑不清楚是否是线程安全。</p>
<p>结论先行：<code>hivevar</code>与<code>hiveconf</code>作用域都<strong>是会话级别</strong>的，言外之意就是如果两个并发同时跑的作业同时传入一个相同key但是value不相同的值的参数，<strong>不会发生线程安全问题</strong>。</p>
<p><strong>3、对于hivevar与hiveconf的使用</strong></p>
<p><code>hiveconf</code> 变量取值必须要使用<code>hiveconf</code>作为前缀参数，具体格式如下:<code>${hiveconf:key}</code></p>
<p>但是对于<code>hivevar</code>取值可以不使用前缀<code>hivevar</code>，具体格式如下：</p>
<ul>
<li><p>使用前缀:   <code>${hivevar:key}</code></p>
</li>
<li><p>不使用前缀:<code>${key}</code></p>
</li>
</ul>
<h3 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h3><p>注意：cli中 tab 会进行自动补全，而且输入流后面的字符会被认为是对提示的回复，因此会导致执行失败</p>
<p><code>!</code>， 不用退出 hive CLI 即可使用shell 命令，在命令前加上感叹号即可：<code>! pwd ;</code></p>
<p>注意：不支持交互式命令、管道命令、文件名模糊匹配功能，如<code>! ls *.hql</code>，查找的是<code>*.hql</code>文件而不是以<code>.hql</code>结尾的所有文件。</p>
<p>hive 中使用 hadoop 命令，只需要去掉<code>hadoop</code>这个关键字即可。而且更加高效，因此 hive 会在同一进程中执行这些命令，而不需要重新启动一个 JVM 实例。</p>
<p>以<code>--</code>开头的字符串是注释。</p>
<h2 id="数据类型与定义"><a href="#数据类型与定义" class="headerlink" title="数据类型与定义"></a>数据类型与定义</h2><h3 id="hive-数据类型"><a href="#hive-数据类型" class="headerlink" title="hive 数据类型"></a>hive 数据类型</h3><table>
<thead>
<tr>
<th style="text-align:left">分类</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">字面量示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">原始类型</td>
<td style="text-align:left">BOOLEAN</td>
<td style="text-align:left">true/false</td>
<td style="text-align:left">TRUE</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">TINYINT</td>
<td style="text-align:left">1字节的有符号整数 -128~127</td>
<td style="text-align:left">1Y</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">SMALLINT</td>
<td style="text-align:left">2个字节的有符号整数，-32768~32767</td>
<td style="text-align:left">1S</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">INT</td>
<td style="text-align:left">4个字节的带符号整数</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">BIGINT</td>
<td style="text-align:left">8字节带符号整数</td>
<td style="text-align:left">1L</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">FLOAT</td>
<td style="text-align:left">4字节单精度浮点数1.0</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">DOUBLE</td>
<td style="text-align:left">8字节双精度浮点数</td>
<td style="text-align:left">1.0</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">DEICIMAL</td>
<td style="text-align:left">任意精度的带符号小数</td>
<td style="text-align:left">1.0</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">STRING</td>
<td style="text-align:left">字符串，变长</td>
<td style="text-align:left">“a”，’b’</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">VARCHAR</td>
<td style="text-align:left">变长字符串</td>
<td style="text-align:left">“a”，’b’</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">CHAR</td>
<td style="text-align:left">固定长度字符串</td>
<td style="text-align:left">“a”，’b’</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">BINARY</td>
<td style="text-align:left">字节数组（v0.8.0+）</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">TIMESTAMP</td>
<td style="text-align:left">时间戳，纳秒精度（v0.8.0+）</td>
<td style="text-align:left">122327493795</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">DATE</td>
<td style="text-align:left">日期</td>
<td style="text-align:left">‘2016-03-29’</td>
</tr>
<tr>
<td style="text-align:left">复杂类型</td>
<td style="text-align:left">ARRAY</td>
<td style="text-align:left">有序的的同类型的集合</td>
<td style="text-align:left">array(1,2)</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">MAP</td>
<td style="text-align:left">key-value,key必须为原始类型，value可以任意类型</td>
<td style="text-align:left">map(‘a’,1,’b’,2)</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">STRUCT</td>
<td style="text-align:left">字段集合,类型可以不同</td>
<td style="text-align:left">struct(‘1’,1,1.0), named_stract(‘col1’,’1’,’col2’,1,’clo3’,1.0)</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">UNION</td>
<td style="text-align:left">在有限取值范围内的一个值</td>
<td style="text-align:left">create_union(1,’a’,63)</td>
</tr>
</tbody>
</table>
<p>不存在最大长度限制的“字符串”，hive 支持无限长度的字符串</p>
<p>进行比较时，hive 会隐式地将类型转为较大的，因此是同类型间的比较</p>
<p>集合类型的问题可能会增大数据冗余的风险，也可能导致数据不一致，当数据发生改变时，冗余的拷贝数据可能无法进行相应的同步。优点是提升更高的吞吐量的数据。</p>
<h3 id="文本文件的保存形式"><a href="#文本文件的保存形式" class="headerlink" title="文本文件的保存形式"></a>文本文件的保存形式</h3><h3 id="分隔符在HIVE中的用途"><a href="#分隔符在HIVE中的用途" class="headerlink" title="分隔符在HIVE中的用途"></a>分隔符在HIVE中的用途</h3><table>
<thead>
<tr>
<th>分隔符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>\n</td>
<td>对于文本文件来说，每行都是一条记录，因此换行符可以分隔记录</td>
</tr>
<tr>
<td>^A(Ctrl+A)</td>
<td>用于分隔字段(列)。在CREATE TABLE语句中可以使用八进制编码\001表示</td>
</tr>
<tr>
<td>^B(Ctrl+B)</td>
<td>用于分隔ARRAY或者STRUCT中的元素，或用于MAP中键-值对之间的分隔。在CREATE TABLE语句中可以使用八进制编码\002表示</td>
</tr>
<tr>
<td>^C(Ctrl+C)</td>
<td>用于MAP中键和值之间的分隔。在CREATE TABLE语句中可以使用八进制编码\003表示</td>
</tr>
</tbody>
</table>
<blockquote>
<p>  Hive 中没有定义专门的数据格式，数据格式可以由用户指定，用户定义数据格式需要指定三个属性：列分隔符（通常为空格、”\t”、”\x001″）、行分隔符（”\n”）以及读取文件数据的方法。由于在加载数据的过程中，不需要从用户数据格式到 Hive 定义的数据格式的转换，因此，Hive 在加载的过程中不会对数据本身进行任何修改，而只是将数据内容复制或者移动到相应的 HDFS 目录中。</p>
</blockquote>
<p>在创建 table 的时候，table 加载文件的时候就会按照下面格式匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">row format delimited </span><br><span class="line">fields terminated by &apos;\001&apos; </span><br><span class="line">collection items terminated by &apos;\002&apos; </span><br><span class="line">map keys terminated by &apos;\003&apos;</span><br><span class="line">lines terminated by &apos;\n&apos; </span><br><span class="line">stored as textfile;</span><br></pre></td></tr></table></figure>
<p><code>row format delimited</code>必须写在其他子句（不包括<code>lines terminated by</code>与<code>stored as textfile</code>）之前。</p>
<p>其实，<code>line terminated by</code>目前只支持<code>\n</code>，<code>stored as textfile</code>也很少用到。</p>
<h3 id="数据校验"><a href="#数据校验" class="headerlink" title="数据校验"></a>数据校验</h3><p>传统数据库是<strong>写时模式</strong>，即 数据在写入数据库的时候对模式（数据格式）进行检查</p>
<p>hive 不会在 数据加载时进行验证，而是在查询时进行，也就是<strong>读时模式</strong></p>
<p>如果模式和文件内容不匹配，hive 容忍性非常好。</p>
<ul>
<li>如果每行记录中字段个数少于对应的模式中定义的字段个数的话，缺失的字段以 null 填充</li>
<li>如果字段是数值型，但 hive 读取时发现存在非数值类型的字符串值的话，那些字段将会返回 null 值</li>
</ul>
<h2 id="HiveQL基本语句"><a href="#HiveQL基本语句" class="headerlink" title="HiveQL基本语句"></a>HiveQL基本语句</h2><p>hive 不支持行级插入、更新、删除操作，也不支持事务。</p>
<p>hive   数据库的概念本质上只是表的一个目录或者命名空间。这样可以避免表名冲突。</p>
<p>如果没有显指定数据库，默认使用 default 数据库</p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show databases;</span><br><span class="line">show databases like &apos;h.*&apos;;   # 支持正则</span><br><span class="line">create database name LOCATION ‘/my/dir/’;   # 指定数据库目录</span><br></pre></td></tr></table></figure>
<p>数据库可以的内容很少，只有<code>DBPROPERTIES</code>可以设置键值对属性，来描述这个数据库的属性信息，其他都是不可改的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert database name SET DBPROPERTIES (&apos;edited-by&apos;=&apos;jizx&apos;);</span><br></pre></td></tr></table></figure>
<h3 id="数据定义"><a href="#数据定义" class="headerlink" title="数据定义"></a>数据定义</h3><h3 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h3><p>通过载入数据的方式创建分区。将<code>$HOME/california-employees</code>   目录下的文件拷贝到分区目录下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load data local inpath &apos;$&#123;env:HOME&#125;/california-employees&apos;</span><br><span class="line">into table emplyees</span><br><span class="line">partition (country = &apos;US&apos;, state = &apos;CA&apos;)</span><br></pre></td></tr></table></figure>
<p>也可以t通过 insert 的方法，也可以通过 <code>alert table...add partition</code>的方法</p>
<h4 id="查看分区"><a href="#查看分区" class="headerlink" title="查看分区"></a>查看分区</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show partitions table_name;</span><br><span class="line">describe extended table_name;   # 更详细的表信息</span><br><span class="line">describe extended table_name PARTITION  (year=2019,month=1,day=2);   # 更详细的分区信息，可以看到 location 信息</span><br></pre></td></tr></table></figure>
<h3 id="外部分区表（最常见）"><a href="#外部分区表（最常见）" class="headerlink" title="外部分区表（最常见）"></a>外部分区表（最常见）</h3><p>使用的目录组织习惯完全由我们自己定义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alert table name ADD PARTITION(year=2019,month=9,day=2)</span><br><span class="line">LOCATITION &apos;hdfs://master_server/data/log_messages/2012/01/02&apos;;</span><br></pre></td></tr></table></figure>
<p>这种灵活性的优点是：我们可以用像 amazon s3 这样的廉价存储设备存储<strong>旧的数据</strong>，在 HDFS 中存储较新的数据。</p>
<p><img src="/2019/10/12/hive/./image1.png" class="lazyload" data-srcset="./image1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20191012145614833"></p>
<h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists table_name;</span><br></pre></td></tr></table></figure>
<p>对于管理表，表的元数据和表内的数据都会被删除。</p>
<p>回收站功能</p>
<p>/user/$USER/.Trash目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.trash.interval=</span><br></pre></td></tr></table></figure>
<p>检查点的时间间隔，单位是分钟。</p>
<p>如果不小心删除了管理表的话，先重建表，然后重建所需要的分区，再从<code>.Trash</code>目录中将误删的文件移动到正确的文件目录下。</p>
<h3 id="修改表"><a href="#修改表" class="headerlink" title="修改表"></a>修改表</h3><p>会修改元数据，但不会修改数据本身</p>
<h4 id="重命名"><a href="#重命名" class="headerlink" title="重命名"></a>重命名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert table log_messages RENAME TO logmsgs;</span><br></pre></td></tr></table></figure>
<h4 id="分区操作"><a href="#分区操作" class="headerlink" title="分区操作"></a>分区操作</h4><p>添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alert table log_messages ADD IF NOT EXISTS</span><br><span class="line">PARTITION (year=2019,month=1,day=1) LOCATITION &apos;/logs/2019/09/01&apos;</span><br><span class="line">PARTITION (year=2019,month=1,day=2) LOCATITION &apos;/logs/2019/09/02&apos;</span><br><span class="line">PARTITION (year=2019,month=1,day=3) LOCATITION &apos;/logs/2019/09/03&apos;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>  0.8.0以上的 hive 可以在一个查询内同时增加多个分区</p>
</blockquote>
<p>修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alert table log_messages PARTITION (year=2019,month=1,day=3)</span><br><span class="line">SET LOCATION &apos;s3n://ourbucket/logs/2011/01/02&apos;</span><br></pre></td></tr></table></figure>
<p>删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert table log_messages DROP IF EXISTs PARTITION (year=2019,month=1,day=3);</span><br></pre></td></tr></table></figure>
<h4 id="列操作"><a href="#列操作" class="headerlink" title="列操作"></a>列操作</h4><p><strong>修改列</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alert table log</span><br><span class="line">CHANGE COLUMN hms new_hms INT</span><br><span class="line">COMMENT &apos;注释&apos;</span><br><span class="line">AFTER other_column;</span><br></pre></td></tr></table></figure>
<p>想放在第一列的话，使用<code>FIRTST</code>代替<code>AFTER other_column</code>即可</p>
<p><strong>添加</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alert table log ADD COLUMN (</span><br><span class="line">	app_name STRING COMMENT &apos;注释&apos;,</span><br><span class="line">	session STRING COMMENT &apos;注释&apos;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><strong>删除或替换列</strong></p>
<p>其实就是将原本的全部的列信息删除掉，然后重新定义列信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alert table log REPLACE COLUMN (</span><br><span class="line">	app_name STRING COMMENT &apos;注释&apos;,</span><br><span class="line">	session STRING COMMENT &apos;注释&apos;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><strong>修改表属性</strong></p>
<p>可以修改或添加，但是无法删除</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alert table log SET TBLPROPERTIES(</span><br><span class="line">	&apos;note&apos; = &apos;笔记内容&apos;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="查看表详细信息"><a href="#查看表详细信息" class="headerlink" title="查看表详细信息"></a>查看表详细信息</h3><p> <code>desc formatted test_table;</code></p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>limit在CLI 中非常经常用到，为了避免执行整个查询语句，有一个配置属性可开启，对原数据进行抽样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hive.limit.optimize.enable=true</span><br><span class="line">hive.limit.row.max.size=1000000    # how much size we need to gurantee each row to have at least</span><br><span class="line">hive.limit.optimize.limit.file=10  # 最多采样的文件数</span><br></pre></td></tr></table></figure>
<p>缺点：有可能输入中有用的数据永远不会被处理到。</p>
<h3 id="创建分区表"><a href="#创建分区表" class="headerlink" title="创建分区表"></a>创建分区表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 建表</span><br><span class="line">&gt; create table supply(id int, part string, quantity int) </span><br><span class="line">&gt; partitioned by (int day);</span><br><span class="line"></span><br><span class="line"># 添加分区</span><br><span class="line">&gt; alert table supply add partiton (day=20190909);</span><br><span class="line"></span><br><span class="line"># 通过 where 选择分区</span><br><span class="line">&gt; select part,quantity from supply</span><br><span class="line">&gt; where day&gt;=20190909 and quantity &lt; 4;</span><br></pre></td></tr></table></figure>
<p>多分区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; ...</span><br><span class="line">&gt; partition by (day int, state string, city string);</span><br></pre></td></tr></table></figure>
<p>理想的分区方案不应该导致产生太多的分区和文件夹目录。</p>
<p>一个分区对应着包含多个文件的文件夹。因此如果存在数百个分区，每天就会创建好几万个文件。默认情况下，MapReduce 会将每个 job转为多个 task，每个 task 都是一个新的 JVM 实例，每个文件都会对应一个 task，因此 JVM 的开启和销毁可能会比实际处理数据的时间还要久。</p>
<p>好的分区方案应该保证分区数量的增长是<strong>均匀的</strong>。</p>
<h3 id="分桶表TODO"><a href="#分桶表TODO" class="headerlink" title="分桶表TODO"></a>分桶表TODO</h3><h3 id="为表增加列"><a href="#为表增加列" class="headerlink" title="为表增加列"></a>为表增加列</h3><p>SerDe 非常宽松，通过指定的分隔符从左向右将行分解成列</p>
<ul>
<li>如果字段数比预期少，那么缺失的字段将返回 null</li>
<li>如果字段数比预期多，那么多出的字段将会被忽略</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert table student add columns (score string);</span><br></pre></td></tr></table></figure>
<p>通过这种方法，无法在已有字段的开始或者中间增加字段</p>
<h3 id="使用列存储表-TODO"><a href="#使用列存储表-TODO" class="headerlink" title="使用列存储表 TODO"></a>使用列存储表 TODO</h3><p>以下两种情况适合列存储表</p>
<h4 id="重复数据，如-age，省市"><a href="#重复数据，如-age，省市" class="headerlink" title="重复数据，如 age，省市"></a>重复数据，如 age，省市</h4><h4 id="多列"><a href="#多列" class="headerlink" title="多列"></a>多列</h4><h3 id="Map-join"><a href="#Map-join" class="headerlink" title="Map join"></a>Map join</h3><p>以下几种情况无法使用map join</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Union Followed by a MapJoin</span><br><span class="line">Lateral View Followed by a MapJoin</span><br><span class="line">Reduce Sink (Group By/Join/Sort By/Cluster By/Distribute By) Followed by MapJoin</span><br><span class="line">MapJoin Followed by Union</span><br><span class="line">MapJoin Followed by Join</span><br><span class="line">MapJoin Followed by MapJoin</span><br></pre></td></tr></table></figure>
<p>相关配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--是否自动转换为mapjoin</span><br><span class="line">set hive.auto.convert.join = true;</span><br><span class="line">--小表的最大文件大小，默认为25000000，即25M</span><br><span class="line">set hive.mapjoin.smalltable.filesize = 25000000;</span><br><span class="line">--是否将多个mapjoin合并为一个</span><br><span class="line">set hive.auto.convert.join.noconditionaltask = true;</span><br><span class="line">--多个mapjoin转换为1个时，所有小表的文件大小总和的最大值。</span><br><span class="line">set hive.auto.convert.join.noconditionaltask.size = 10000000;</span><br></pre></td></tr></table></figure>
<h4 id="确保多张小表使用-mapjoin"><a href="#确保多张小表使用-mapjoin" class="headerlink" title="确保多张小表使用 mapjoin"></a>确保多张小表使用 mapjoin</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="comment">/*+MAPJOIN(smallTableTwo)*/</span> idOne, idTwo, <span class="keyword">value</span> <span class="keyword">FROM</span></span><br><span class="line">  ( <span class="keyword">select</span> <span class="comment">/*+MAPJOIN(smallTableOne)*/</span> idOne, idTwo, <span class="keyword">value</span> <span class="keyword">FROM</span></span><br><span class="line">    bigTable <span class="keyword">JOIN</span> smallTableOne <span class="keyword">on</span> (bigTable.idOne = smallTableOne.idOne)                             </span><br><span class="line">  ) firstjoin                                                            </span><br><span class="line">  <span class="keyword">JOIN</span>                                                                 </span><br><span class="line">  smallTableTwo <span class="keyword">ON</span> (firstjoin.idTwo = smallTableTwo.idTwo)</span><br></pre></td></tr></table></figure>
<p>除了添加 mapjoin提示，还需要设置两个参数</p>
<ul>
<li><p>hive.auto.convert.join.noconditionaltask=true</p>
<blockquote>
<p>  如果启用此参数，并且n向连接的表/分区的n-1个大小的总和&lt;指定的大小，则该连接将直接转换为mapjoin（没有条件任务）。</p>
</blockquote>
</li>
<li><p>hive.auto.convert.join.noconditionaltask.size=1000000</p>
<blockquote>
<p>  如果n路联接的n个表/分区的n-1个大小的总和小于此大小，该连表将直接转换为mapjoin（没有条件任务）。 默认值为10MB。</p>
</blockquote>
</li>
</ul>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Joins" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Joins</a></p>
<h2 id="导入导出数据"><a href="#导入导出数据" class="headerlink" title="导入导出数据"></a>导入导出数据</h2><h3 id="动态分区插入"><a href="#动态分区插入" class="headerlink" title="动态分区插入"></a>动态分区插入</h3><p>可以基于查询参数推断出需要创建的分区名称。SELECT 语句中的最后 2 列会对应到 PARTITION 中的分区名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT OVERWRITE TSBLE employees</span><br><span class="line">PARTITION(country, state)</span><br><span class="line">SELECT ..., se.cnty,se.st</span><br><span class="line">FROM staged_employees se;</span><br></pre></td></tr></table></figure>
<p>动静结合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSERT OVERWRITE TSBLE employees</span><br><span class="line">PARTITION(country = &apos;US&apos;, state)   # 静态分区键必须出现在动态分区键之前</span><br><span class="line">SELECT ..., se.cnty,se.st</span><br><span class="line">FROM staged_employees se</span><br><span class="line">WHERE se.cnty = &apos;US&apos;;</span><br></pre></td></tr></table></figure>
<h3 id="单个查询语句中创建表并加装数据"><a href="#单个查询语句中创建表并加装数据" class="headerlink" title="单个查询语句中创建表并加装数据"></a>单个查询语句中创建表并加装数据</h3><p>这个功能不能用于外部表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE ca_employees</span><br><span class="line">AS SELECT name, salary, address</span><br><span class="line">FROM employees</span><br><span class="line">WHERE se.state = &apos;CA&apos;;</span><br></pre></td></tr></table></figure>
<h3 id="导出数据"><a href="#导出数据" class="headerlink" title="导出数据"></a>导出数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT OVERWRITE LOCAL DIRECTORY &apos;/tmp/employees&apos;</span><br><span class="line">select name</span><br><span class="line">from employee</span><br><span class="line">where se.state = &apos;CA&apos;</span><br></pre></td></tr></table></figure>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><p><code>select sub[0] from table_name;</code> 查询<strong>数组</strong>类型的字段的第一个元素</p>
<p><code>select ded[“state taxes”] from table_name;</code> 查询<strong>map</strong>类型的字段</p>
<p><code>select address.city from table_name;</code> 查询<strong>struct</strong>类型的字段</p>
<p>使用正则表达式来指定列，所有以 price 开头的列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select `price.*` from stocks;</span><br></pre></td></tr></table></figure>
<p>不允许使用多个 DISTINCT 函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(DISTINCT ymd),count (DISTINCT volume) from stocks;</span><br></pre></td></tr></table></figure>
<p>存在的 bug <code>count(DISTINCT col)</code>同时 col 是分区列时，会出现 bug</p>
<p>表生成函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT name, sub </span><br><span class="line">FROM udtf_test</span><br><span class="line">LATERAL VIEW explode(subordinates) subView AS sub;</span><br></pre></td></tr></table></figure>
<p>在这里LATERAL VIEW 是将 explode结果转换成一个视图subView,在视图中的单列列名定义为sub，然后在查询的时候引用这个列名就能够查到。</p>
<p>与时间相关的函数 ，输入可以是整数或者字符串类型。对于 0.8.0，可以接受 TIMESTAMP 类型的参数。</p>
<p>列别名 <code>SELECT  col as new_col FROM table_name</code></p>
<p>对列的进一步处理，进行条件判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Select  </span><br><span class="line">    CASE </span><br><span class="line">     WHEN salary &gt; 7 AND salary &lt;10 THEN &apos;high&apos;</span><br><span class="line">     ELSE &apos;very high&apos;</span><br><span class="line">    END AS bracket </span><br><span class="line">FROM employees</span><br></pre></td></tr></table></figure>
<p>最好将下面的设置添加到 hiverc 中，避免不必要的 <code>MapReduce</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set  hive.exec.mode.local.auto=true</span><br></pre></td></tr></table></figure>
<h3 id="where"><a href="#where" class="headerlink" title="where"></a>where</h3><p>where 语句使用<strong>谓词表达式</strong>，谓词表达式结果为 true 时，相应的行将被保留和输出。</p>
<p>where 语句中并不能使用 select 语句中的别名，解决办法是使用嵌套 select 语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT e.* FROM</span><br><span class="line">  ( select salary*(1- ded[&quot;Taxes&quot;]) as new_salary</span><br><span class="line">    FROM employees) e</span><br><span class="line">WHERE round(e.new_salary) &gt; 7000</span><br></pre></td></tr></table></figure>
<h4 id="关于浮点数比较的陷阱"><a href="#关于浮点数比较的陷阱" class="headerlink" title="关于浮点数比较的陷阱"></a>关于浮点数比较的陷阱</h4><p>hive无法精确的表示 0.2，如果转为 float，实际数值是：0.2000001。如果转为 double，实际数值是：0.200000000001。</p>
<p>sql 语句中的浮点数，默认是 Double 类型的，比如下面的0.2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from name wheren high&gt; 0.2</span><br></pre></td></tr></table></figure>
<p>如果表的字段定义时是 Float 类型，就会出现比较上的问题。输出中会有=0.2 的。</p>
<p>Float字段会隐式转为 Double 类型，变成：0.20000001000000，因此会比 0.2 的double 类型0.200000000001大。 </p>
<p>因此会出现 <code>&gt;0.2</code>的效果与<code>&gt;=0.2</code>相同。</p>
<p>解决办法：</p>
<ol>
<li>将字段类型保存为 double，缺点是查询时内存消耗增多</li>
<li>sql 中的数字显示指定类型<code>WHERE high &gt; cast(0.2 AS FLOAT)</code></li>
<li>与钱相关的都避免使用浮点数</li>
</ol>
<h3 id="GROUP-BY-语句"><a href="#GROUP-BY-语句" class="headerlink" title="GROUP BY 语句"></a>GROUP BY 语句</h3><p>having 语句用于聚合后再进行的条件过滤，避免了子查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select avg(salary) From stocks</span><br><span class="line">where ...</span><br><span class="line">GROUP BY year(ymd)</span><br><span class="line">HAVING avg(salary) &gt; 50.0   # 对上面的聚合后的内容进行过滤</span><br></pre></td></tr></table></figure>
<h3 id="join-语句"><a href="#join-语句" class="headerlink" title="join 语句"></a>join 语句</h3><ul>
<li><p>join on 只支持等值连接，也就是<code>a.col=b.col</code> ，不支持<code>a.col&lt; b.col</code></p>
</li>
<li><p>不支持在 on 子句中的谓词使用 OR</p>
</li>
<li><p>hive 假定从左到右边表依次变大，也可以在 SELECT 中添加<code>/*+STREAMTABLE(s)*/</code></p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT /*+STREAMTABLE(s)*/   s.ymd,s.symbol</span><br><span class="line">FROM stocks s JOIN dividends d ON ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>ON语句中的分区过滤条件在 OUTER JOIN 中是无效的，在 INNER JOIN 中是有效的 TODO（不太明白）</p>
</li>
<li><p>full outer join 将会返回所有表中符合 WHERE 语句条件的所有记录。如果任一张表的指定字段没有符合条件的值的话，那么就是用 NULL 值代替。</p>
</li>
</ul>
<h4 id="LEFT-SEMI-JOIN"><a href="#LEFT-SEMI-JOIN" class="headerlink" title="LEFT SEMI-JOIN"></a>LEFT SEMI-JOIN</h4><p>左半开连接会返回左边表的记录，前提是其记录对于满足 ON 语句中的判定条件。</p>
<p><img src="/2019/10/12/hive/2019-10-12-hive/image2.png" class="lazyload" data-srcset="2019-10-12-hive/image2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20191015111109600"></p>
<h4 id="map-join"><a href="#map-join" class="headerlink" title="map  join"></a>map  join</h4><p>0.7之前的需要在 SELECT 中添加标记来进行触发，如下面的内连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT /*+MAPJOIN(d)*/ s.ymd, s.symbol, d.dividend </span><br><span class="line">FROM stocks s JOIN dividends d ON s.ymd=d.ymd</span><br><span class="line">WHERE s.symbol = &apos;AAPL&apos;</span><br></pre></td></tr></table></figure>
<p>0.7之后的版本，废弃这种标记，不过添加后同样是有效的。如果没有该标记，需要用户设置属性<code>hive.auto.convert.JOIN=true</code>，也可以配置小表的大小<code>hive.mapjoin.smalltable.filesize=25000000</code> 单位是字节</p>
<h3 id="ORDER-BY-和-SORT-BY"><a href="#ORDER-BY-和-SORT-BY" class="headerlink" title="ORDER BY 和 SORT BY"></a>ORDER BY 和 SORT BY</h3><p>sort by 是局部的，order by 是全局的，比较费时。</p>
<h3 id="DISTRIBUTE-BY与-CLUSTER-BY"><a href="#DISTRIBUTE-BY与-CLUSTER-BY" class="headerlink" title="DISTRIBUTE BY与 CLUSTER BY"></a>DISTRIBUTE BY与 CLUSTER BY</h3><p>Distribute by 用来保证相同指定列的记录会分发到同一个 reducer 中。</p>
<p>如果DISTRIBUTE 与 SORT 语句中都涉及到相同的列，而且采用的是升序排序方式，那么这时 CLUSTER BY 等价于前面的两个语句。</p>
<p>CLUSTER BY 剥夺了 SORT BY 的并行性，但是这样可以实现输出的数据是全局排序的。</p>
<h3 id="抽样查询"><a href="#抽样查询" class="headerlink" title="抽样查询"></a>抽样查询</h3><p>方式1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from numbers TABLESAMPLE(BUCKET 1 OUT OF 2 ON col1) s;</span><br></pre></td></tr></table></figure>
<p>2表示将数据分散成几桶，1 表示选择第几桶</p>
<p>方式 2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from numbersflat TABLESAMPLE(0.1 PERCENT) s;</span><br></pre></td></tr></table></figure>
<p>基于行数的，按照输入路径下的数据块百分比进行抽样。</p>
<ul>
<li>不一定适合所有文件格式</li>
<li>抽样最小单元是一个 HDFS 数据块，如果标的数据大小 &lt; 普通的块大小 128MB 的话，将返回所有行</li>
</ul>
<h3 id="UNION-ALL"><a href="#UNION-ALL" class="headerlink" title="UNION ALL"></a>UNION ALL</h3><p>hive中比较低的版本没有 union，只有 union all</p>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><ul>
<li>将复杂的多层子嵌套进行封装，类似于使用函数一样。</li>
<li>安全机制，不直接给用户访问敏感数据的原始表，而是提供给用户通过 where 限制了的视图。（目前 hive 并不支持，用户必须具有原始表的权限，视图才能工作）</li>
<li>可以理解为：hive 会先解析视图，然后使用解析结果来解析整个查询语句，不过查询优化器<strong>可能会将视图和查询语句合并成一个单一的实际查询语句。</strong>如果视图中包含 ORDER BY 或者 LIMIT，则会先解析视图。</li>
<li>通过 show tables 来查询视图，没有 show views 这样的语句</li>
</ul>
<p>describe 和describe extended 可以显示视图的元数据信息</p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="数据的导入与导出"><a href="#数据的导入与导出" class="headerlink" title="数据的导入与导出"></a>数据的导入与导出</h3><p>1）加载到普通表</p>
<p>加载本地文本文件内容（要与hive表字段分隔符顺序都要一致）</p>
<pre><code>load data local inpath &apos;/home/hadoop/orders.csv&apos; overwrite into table orders;
</code></pre><p>如果数据源在HDFS上，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data inpath &apos;hdfs://master:9000/user/orders&apos; overwrite into table orders;  数据源在HDFS上</span><br></pre></td></tr></table></figure>
<p>2) 加载到分区表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data local inpath &apos;/home/hadoop/test.txt&apos; overwrite into table test partition (dt=&apos;2017-09-09&apos;);</span><br></pre></td></tr></table></figure>
<p>partition 是指定这批数据放入分区2017-09-09中；</p>
<p>3）加载分桶表<br>先创建普通临时表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> orders_tmp</span><br><span class="line">(</span><br><span class="line">user_id <span class="built_in">int</span>,</span><br><span class="line">user_name <span class="keyword">string</span>,</span><br><span class="line">create_time <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">','</span> <span class="keyword">stored</span> <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure>
<p>数据载入临时表</p>
<pre><code>load data local inpath &apos;/home/hadoop/lead.txt&apos; overwrite into table orders_tmp; 
</code></pre><p>导入分桶表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set hive.enforce.bucketing = true;</span><br><span class="line">insert overwrite table orders select * from orders_tmp;</span><br></pre></td></tr></table></figure>
<p>4) 导出数据</p>
<p>将hive表中的数据导出到本地文件中；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert overwrite local directory &apos;/home/hadoop/orders.bak2017-12-28&apos; select * from orders;</span><br></pre></td></tr></table></figure>
<p>【去掉local关键字，也可以导出到HDFS上】</p>
<h3 id="JOIN-ON中的-and-与-where-子句"><a href="#JOIN-ON中的-and-与-where-子句" class="headerlink" title="JOIN ON中的 and 与 where 子句"></a>JOIN ON中的 and 与 where 子句</h3><p>HiveQL与标准SQL的区别：</p>
<p>陷阱1：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> first_table t1</span><br><span class="line"><span class="keyword">JOIN</span> second_table t2</span><br><span class="line"><span class="keyword">ON</span> t1.id = t2.id</span><br><span class="line">	<span class="keyword">where</span> t1.date = <span class="string">"2016-06-01"</span></span><br></pre></td></tr></table></figure>
<p>在hive里面，没有SQL优化器，则这样些的后果是，直接将t1表与t2表全量连接，产生大量的MapReduce操作再进行过滤</p>
<p>正确写法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">( <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> first_table <span class="keyword">WHERE</span> <span class="built_in">date</span> = <span class="string">"2016-06-01"</span>) t1</span><br><span class="line"><span class="keyword">JOIN</span> second_table t2</span><br><span class="line"><span class="keyword">ON</span> t1.id = t2.id;</span><br></pre></td></tr></table></figure>
<p>其实上面的语句还不是最好的,因为hive通常处理的都是大数据表,上亿至少小case。<strong>hive sql里不推荐用嵌套子查询语句</strong>，就是为了减小查询负担。</p>
<p>更优的写法是join…on 后面，用and代替where。为什么？用and的话，查询是先过滤条件，得到一个较小的表，然后再跟其他表联合。这样，无形中，就能节省下不小的运算量，自然就更快了！</p>
<p>更优的写法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> first_table t1</span><br><span class="line"><span class="keyword">JOIN</span> second_table t2</span><br><span class="line"><span class="keyword">ON</span> t1.id = t2.id</span><br><span class="line"><span class="keyword">and</span> t1.date = <span class="string">"2016-06-01"</span>;</span><br></pre></td></tr></table></figure>
<p><a href="https://www.jianshu.com/p/ad64b953dc67" target="_blank" rel="noopener">https://www.jianshu.com/p/ad64b953dc67</a></p>
<h3 id="合并小文件"><a href="#合并小文件" class="headerlink" title="合并小文件"></a>合并小文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -cat hdfs://cdh5/tmp/lxw1234/*.txt | hadoop fs -appendToFile - hdfs://cdh5/tmp/hdfs_largefile.txt</span><br></pre></td></tr></table></figure>
<p>这种处理方法在<strong>数据量非常大的情况下不适合</strong>，最好使用MapReduce来合并。</p>
</the></excerpt>
  
  
    
    <div class='footer'>
      
      
      
        <div class='copyright'>
          <blockquote>
            
              
                <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

              
            
              
                <p>本文永久链接是：<a href=https://jizx.vip/2019/10/12/hive/>https://jizx.vip/2019/10/12/hive/</a></p>
              
            
          </blockquote>
        </div>
      
      
    </div>
  
  
    


  <div class='article-meta' id="bottom">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-02-04T20:09:25+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：Feb 4, 2020</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/hive/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>hive</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/ing/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>ing</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://jizx.vip/2019/10/12/hive/&title=hive - 玖玖的博客&summary= 

hive 的读书笔记，ing"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/qq.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/qq.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://jizx.vip/2019/10/12/hive/&title=hive - 玖玖的博客&summary= 

hive 的读书笔记，ing"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/qzone.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/qzone.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://jizx.vip/2019/10/12/hive/&title=hive - 玖玖的博客&summary= 

hive 的读书笔记，ing"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/weibo.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/128/weibo.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=">
          
        </a>
      
    
      
    
      
    
  </div>
</div>



        
      
    </div>
  </div>


  
  

  
    <div class="prev-next">
      
        <a class='prev' href='/2019/10/25/开发环境搭建与效率技巧/'>
          <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>开发环境搭建与效率技巧</p>
          <p class='content'> 

Mac、linux、window这 3 大系统的开发环境搭建推荐、遇到的相关问题的解决方案记录





通用环境Python 环境macOS安装 anaconda
更多请查看 anaco...</p>
        </a>
      
      
        <a class='next' href='/2019/10/11/linux知识点/'>
          <p class='title'>linux知识点<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
          <p class='content'> 






内核通过硬盘上的存储空间来实现虚拟内存，这块区域称为交换空间（swap space）。
系统的运行级别运行级为1时，只启动基本的系统进程以及一个控制台终端进程。我们称之为单用户模...</p>
        </a>
      
    </div>
  
</article>


  

  <article class="post white-box reveal shadow" id="comments">
    <p ct><i class='fas fa-comments'></i> 评论</p>
    
    <div id="valine_container" class="valine_thread">
  <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
</div>

  </article>






</div>
<aside class='l_side'>
  
  
    
    



  <section class="widget toc-wrapper shadow desktop mobile" id="toc-div" >
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TODO"><span class="toc-text">TODO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hive-变量空间"><span class="toc-text">hive 变量空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CLI"><span class="toc-text">CLI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据类型与定义"><span class="toc-text">数据类型与定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hive-数据类型"><span class="toc-text">hive 数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文本文件的保存形式"><span class="toc-text">文本文件的保存形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分隔符在HIVE中的用途"><span class="toc-text">分隔符在HIVE中的用途</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据校验"><span class="toc-text">数据校验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HiveQL基本语句"><span class="toc-text">HiveQL基本语句</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库"><span class="toc-text">数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据定义"><span class="toc-text">数据定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分区表"><span class="toc-text">分区表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查看分区"><span class="toc-text">查看分区</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#外部分区表（最常见）"><span class="toc-text">外部分区表（最常见）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除表"><span class="toc-text">删除表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改表"><span class="toc-text">修改表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#重命名"><span class="toc-text">重命名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分区操作"><span class="toc-text">分区操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#列操作"><span class="toc-text">列操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看表详细信息"><span class="toc-text">查看表详细信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#优化"><span class="toc-text">优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建分区表"><span class="toc-text">创建分区表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分桶表TODO"><span class="toc-text">分桶表TODO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为表增加列"><span class="toc-text">为表增加列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用列存储表-TODO"><span class="toc-text">使用列存储表 TODO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#重复数据，如-age，省市"><span class="toc-text">重复数据，如 age，省市</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#多列"><span class="toc-text">多列</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Map-join"><span class="toc-text">Map join</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#确保多张小表使用-mapjoin"><span class="toc-text">确保多张小表使用 mapjoin</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#导入导出数据"><span class="toc-text">导入导出数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#动态分区插入"><span class="toc-text">动态分区插入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#单个查询语句中创建表并加装数据"><span class="toc-text">单个查询语句中创建表并加装数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#导出数据"><span class="toc-text">导出数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询"><span class="toc-text">查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#select"><span class="toc-text">select</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#where"><span class="toc-text">where</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#关于浮点数比较的陷阱"><span class="toc-text">关于浮点数比较的陷阱</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GROUP-BY-语句"><span class="toc-text">GROUP BY 语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#join-语句"><span class="toc-text">join 语句</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LEFT-SEMI-JOIN"><span class="toc-text">LEFT SEMI-JOIN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#map-join"><span class="toc-text">map  join</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ORDER-BY-和-SORT-BY"><span class="toc-text">ORDER BY 和 SORT BY</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DISTRIBUTE-BY与-CLUSTER-BY"><span class="toc-text">DISTRIBUTE BY与 CLUSTER BY</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#抽样查询"><span class="toc-text">抽样查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UNION-ALL"><span class="toc-text">UNION ALL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#视图"><span class="toc-text">视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引"><span class="toc-text">索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他"><span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据的导入与导出"><span class="toc-text">数据的导入与导出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JOIN-ON中的-and-与-where-子句"><span class="toc-text">JOIN ON中的 and 与 where 子句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#合并小文件"><span class="toc-text">合并小文件</span></a></li></ol></li></ol>
    </div>
  </section>


  


</aside>



      </div>
      
  
  <footer class="footer clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
          
            
          
            
          
        </div>
      
    
      
        <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
      
    
      
        
          <div><p><span id="lc-sv">本站总访问量为 <span id='number'><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span> 次</span> <span id="lc-uv">访客数为 <span id='number'><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span> 人</span></p>
</div>
        
      
    
      
        Use
        <a href="https://github.com/volantis-x/hexo-theme-volantis/tree/4.0.0-rc.4" target="_blank" class="codename">Volantis</a>
        as theme
      
    
      
        <div class='copyright'>
        <p><a href="/">Copyright © 2017-2020 XXX</a></p>

        </div>
      
    
  </footer>


      <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
    </div>
  </div>
  <div>
    <!-- required -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5/dist/jquery.min.js"></script>
<script>
  function pjax_fancybox() {
    $(".md .gallery").find("img").each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("class", "fancybox");
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 判断当前页面是否存在描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".md .gallery").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  function SCload_fancybox() {
    if ($(".md .gallery").find("img").length == 0) return;
    loadCSS("https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css", document.getElementById("loadcss"));
    setTimeout(function() {
      loadScript('https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', pjax_fancybox)
    }, 1);
  };
  $(function () {
    SCload_fancybox();
  });
</script>


<!-- internal -->







  <script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>




  
  
    <script>
      window.FPConfig = {
        delay: 0,
        ignoreKeywords: [],
        maxRPS: 5,
        hoverDelay: 25
      };
    </script>
    <script defer src="https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"></script>
  










  
  <script src="/js/valine.js"></script>

<script>
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link'.split(',').filter(function (item) {
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick', 'mail', 'link'];
  var requiredFields = 'nick,mail'.split(',').filter(function (item) {
    return REQUIRED_FIELDS.indexOf(item) > -1
  });

  function emoji(path, idx, ext) {
    return path + "/" + path + "-" + idx + "." + ext;
  }

  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }

  function pjax_valine() {
    if(!document.querySelectorAll("#valine_container")[0])return;

    let pagePlaceholder = $.trim($('#pjax-comment-placeholder').text()) || "快来评论吧~";

    let path = $.trim($('#pjax-comment-path').text());
    if (path.length == 0) {
      let defaultPath = '';
      path = defaultPath || decodeURI(window.location.pathname);
    }

    var valine = new Valine();
    valine.init({
      el: '#valine_container',
      meta: meta,
      placeholder: pagePlaceholder,
      path: path,
      appId: "",
      appKey: "",
      pageSize: '10',
      avatar: 'robohash',
      lang: 'zh-cn',
      visitor: 'true',
      highlight: 'true',
      mathJax: 'false',
      enableQQ: 'true',
      requiredFields: requiredFields,
      emojiCDN: 'https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/valine/',
      emojiMaps: emojiMaps
    })
  }

  $(function () {
    pjax_valine();
  });
</script>







  <script src="/js/app.js"></script>



  
    <script src="/js/search.js"></script>
  


<!-- optional -->

  <script>
const SearchServiceimagePath="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@master/img/";
const ROOT =  ("/" || "/").endsWith('/') ? ("/" || "/") : ("//" || "/" );
(function ($) {
  
    customSearch = new HexoSearch({
      imagePath: SearchServiceimagePath
    });
  
})(jQuery);

</script>











  <script defer>

  const LCCounter = {
    app_id: 'u9j57bwJod4EDmXWdxrwuqQT-MdYXbMMI',
    app_key: 'jfHtEKVE24j0IVCGHbvuFClp',
    custom_api_server: '',

    // 查询存储的记录
    getRecord(Counter, url, title) {
      return new Promise(function (resolve, reject) {
        Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({url})))
          .then(resp => resp.json())
          .then(({results, code, error}) => {
            if (code === 401) {
              throw error;
            }
            if (results && results.length > 0) {
              var record = results[0];
              resolve(record);
            } else {
              Counter('post', '/classes/Counter', {url, title: title, times: 0})
                .then(resp => resp.json())
                .then((record, error) => {
                  if (error) {
                    throw error;
                  }
                  resolve(record);
                }).catch(error => {
                console.error('Failed to create', error);
                reject(error);
              });
            }
          }).catch((error) => {
          console.error('LeanCloud Counter Error:', error);
          reject(error);
        });
      })
    },

    // 发起自增请求
    increment(Counter, incrArr) {
      return new Promise(function (resolve, reject) {
        Counter('post', '/batch', {
          "requests": incrArr
        }).then((res) => {
          res = res.json();
          if (res.error) {
            throw res.error;
          }
          resolve(res);
        }).catch((error) => {
          console.error('Failed to save visitor count', error);
          reject(error);
        });
      });
    },

    // 构建自增请求体
    buildIncrement(objectId) {
      return {
        "method": "PUT",
        "path": `/1.1/classes/Counter/${ objectId }`,
        "body": {
          "times": {
            '__op': 'Increment',
            'amount': 1
          }
        }
      }
    },

    // 校验是否为有效的 UV
    validUV() {
      var key = 'LeanCloudUVTimestamp';
      var flag = localStorage.getItem(key);
      if (flag) {
        // 距离标记小于 24 小时则不计为 UV
        if (new Date().getTime() - parseInt(flag) <= 86400000) {
          return false;
        }
      }
      localStorage.setItem(key, new Date().getTime().toString());
      return true;
    },

    addCount(Counter) {
      var enableIncr = '' === 'true' && window.location.hostname !== 'localhost';
      enableIncr = true;
      var getterArr = [];
      var incrArr = [];
      // 请求 PV 并自增
      var pvCtn = document.querySelector('#lc-sv');
      if (pvCtn || enableIncr) {
        var pvGetter = this.getRecord(Counter, 'https://jizx.vip' + '/#lc-sv', 'Visits').then((record) => {
          incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-sv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + 1;
              if (pvCtn) {
                pvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(pvGetter);
      }

      // 请求 UV 并自增
      var uvCtn = document.querySelector('#lc-uv');
      if (uvCtn || enableIncr) {
        var uvGetter = this.getRecord(Counter, 'https://jizx.vip' + '/#lc-uv', 'Visitors').then((record) => {
          var vuv = this.validUV();
          vuv && incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-uv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + (vuv ? 1 : 0);
              if (uvCtn) {
                uvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(uvGetter);
      }

      // 请求文章的浏览数，如果是当前页面就自增
      var allPV = document.querySelectorAll('#lc-pv');
      if (allPV.length > 0 || enableIncr) {
        for (i = 0; i < allPV.length; i++) {
          let pv = allPV[i];
          let title = pv.getAttribute('data-title');
          var url = 'https://jizx.vip' + pv.getAttribute('data-path');
          if (url) {
            var viewGetter = this.getRecord(Counter, url, title).then((record) => {
              // 是当前页面就自增
              let curPath = window.location.pathname;
              if (curPath.includes('index.html')) {
                curPath = curPath.substring(0, curPath.lastIndexOf('index.html'));
              }
              if (pv.getAttribute('data-path') == curPath) {
                incrArr.push(this.buildIncrement(record.objectId));
              }
              if (pv) {
                var ele = pv.querySelector('#lc-pv #number');
                if (ele) {
                  if (pv.getAttribute('data-path') == curPath) {
                    ele.innerText = (record.times || 0) + 1;
                  } else {
                    ele.innerText = record.times || 0;
                  }
                  pv.style.display = 'inline';
                }
              }
            });
            getterArr.push(viewGetter);
          }
        }
      }

      // 如果启动计数自增，批量发起自增请求
      if (enableIncr) {
        Promise.all(getterArr).then(() => {
          incrArr.length > 0 && this.increment(Counter, incrArr);
        })
      }

    },


    fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${ api_server }/1.1${ url }`, {
          method,
          headers: {
            'X-LC-Id': this.app_id,
            'X-LC-Key': this.app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      this.addCount(Counter);
    },

    refreshCounter() {
      var api_server = this.app_id.slice(-9) !== '-MdYXbMMI' ? this.custom_api_server : `https://${ this.app_id.slice(0, 8).toLowerCase() }.api.lncldglobal.com`;
      if (api_server) {
        this.fetchData(api_server);
      } else {
        fetch('https://app-router.leancloud.cn/2/route?appId=' + this.app_id)
          .then(resp => resp.json())
          .then(({api_server}) => {
            this.fetchData('https://' + api_server);
          });
      }
    }

  };

  LCCounter.refreshCounter();

  document.addEventListener('pjax:complete', function () {
    LCCounter.refreshCounter();
  });
</script>



<!-- more -->


    
      

<script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script>
<!-- 样式位于：source/css/_third-party/pjaxanimate.styl -->

<div class="pjax-animate">
  
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>
    <div id="loading-bar-wrapper"><script>NProgress.configure({parent:"#loading-bar-wrapper",trickleSpeed: 100})</script></div>
    <script>
      window.ShowLoading = function() {
        NProgress.start();
      };
      window.HideLoading = function() {
        NProgress.done();
      }
    </script>
  
</div>

<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox])',
        selectors: [
          "title",
          "#pjax-container",
          "#pjax-header-nav-list"
        ],
        cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
        timeout: 5000
      });
    });

    document.addEventListener('pjax:send', function (e) {
      window.stop(); // 相当于点击了浏览器的停止按钮

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      window.subData = null; // 移除标题（用于一二级导航栏切换处）
      if (typeof $.fancybox != "undefined") {
        $.fancybox.close();    // 关闭弹窗
      }
      $('.l_header .switcher .s-search').removeClass('active'); // 关闭移动端激活的搜索框
      $('.l_header').removeClass('z_search-open'); // 关闭移动端激活的搜索框
      $('.wrapper').removeClass('sub'); // 跳转页面时关闭二级导航

      // 解绑事件 避免重复监听
      $('.s-top').unbind('click');
      $('.menu a').unbind('click');
      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');
      window.ShowLoading();
    });

    document.addEventListener('pjax:complete', function () {
      // 关于百度统计对 SPA 页面的处理：
      // 方案一：百度统计>管理>单页应用设置中，打开开启按钮即可对SPA进行统计。 https://tongji.baidu.com/web/help/article?id=324
      // 方案二：取消注释下列代码。 https://tongji.baidu.com/web/help/article?id=235
      // 

      // 关于谷歌统计对 SPA 页面的处理：
      // 当应用以动态方式加载内容并更新地址栏中的网址时，也应该更新通过 gtag.js 存储的网页网址。
      // https://developers.google.cn/analytics/devguides/collection/gtagjs/single-page-applications?hl=zh-cn
      

      $('.nav-main').find('.list-v').not('.menu-phone').removeAttr("style",""); // 移除小尾巴的移除
      $('.menu-phone.list-v').removeAttr("style",""); // 移除小尾巴的移除
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
      try{
          if (typeof $.fancybox == "undefined") {
            SCload_fancybox();
          } else {
            pjax_fancybox();
          }
        
        
        
        
        
        
          pjax_valine();
        
        
        
        
        
      } catch (e) {
        console.log(e);
      }
      window.HideLoading();
    });

    document.addEventListener('pjax:error', function (e) {
      window.HideLoading();
      window.location.href = e.triggerElement.href;
    });
</script>

    
  </div>
</body>
</html>
